import traceback
from operations import TopOperation
from operations import JoinOperation
from operations import AggregationOperation
from operations import FormulaOperation
from operations import FilterOperation
from connectors import DBFSConnector
from connectors import CosmosDBConnector
from datatransformations import TranformationsMainFlow
from automl import tpot_execution
from core import PipelineNotification
import json

PipelineNotification.PipelineNotification().started_notification('5da5c65e3cba417ba39880f5','5df78f4be2f2eff24740bbd7','http://13.68.212.36:3200/pipeline/notify')
source = DBFSConnector.DBFSConnector.fetch([], {}, "5da5c65e3cba417ba39880f5", spark, "{'url': '/Demo/PredictiveChurnTrain.csv', 'file_type': 'Delimeted', 'dbfs_token': 'dapi0ef076722999cf4cd8859e9aafdb7b76', 'dbfs_domain': 'westus.azuredatabricks.net', 'delimiter': ',', 'is_header': 'Use Header Line'}")
PipelineNotification.PipelineNotification().completed_notification('5da5c65e3cba417ba39880f5','5df78f4be2f2eff24740bbd7','http://13.68.212.36:3200/pipeline/notify')
PipelineNotification.PipelineNotification().started_notification('5da5c65e3cba417ba39880f6','5df78f4be2f2eff24740bbd7','http://13.68.212.36:3200/pipeline/notify')
transformations = TranformationsMainFlow.TramformationMain.run(["5da5c65e3cba417ba39880f5"],{"5da5c65e3cba417ba39880f5": source}, "5da5c65e3cba417ba39880f6", spark,json.dumps( {"FE": [{"transformationsData": {"feature_label": "State"}, "feature": "State", "transformation": "String Indexer", "type": "string", "selected": "True", "stats": {"count": "341", "mean": "", "stddev": "", "min": "AK", "max": "WY", "missing": "0", "distinct": "51"}}, {"transformationsData": {}, "feature": "Account_Length", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "101.59", "stddev": "40.81", "min": "1", "max": "243", "missing": "0"}}, {"transformationsData": {}, "feature": "Area_Code", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "437.5", "stddev": "42.25", "min": "408", "max": "510", "missing": "0"}}, {"transformationsData": {"feature_label": "Phone"}, "feature": "Phone", "transformation": "String Indexer", "type": "string", "selected": "True", "stats": {"count": "341", "mean": "", "stddev": "", "min": "327-3587", "max": "422-7728", "missing": "0", "distinct": "341"}}, {"transformationsData": {"feature_label": "Intl_Plan"}, "feature": "Intl_Plan", "transformation": "String Indexer", "type": "string", "selected": "True", "stats": {"count": "341", "mean": "", "stddev": "", "min": "no", "max": "yes", "missing": "0", "distinct": "2"}}, {"transformationsData": {"feature_label": "VMail_Plan"}, "feature": "VMail_Plan", "transformation": "String Indexer", "type": "string", "selected": "True", "stats": {"count": "341", "mean": "", "stddev": "", "min": "no", "max": "yes", "missing": "0", "distinct": "2"}}, {"transformationsData": {}, "feature": "VMail_Message", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "8.62", "stddev": "14.28", "min": "0", "max": "50", "missing": "0"}}, {"transformationsData": {}, "feature": "Day_Mins", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "173.84", "stddev": "56.06", "min": "7.8", "max": "307.1", "missing": "0"}}, {"transformationsData": {}, "feature": "Day_Calls", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "100.36", "stddev": "19.17", "min": "40", "max": "150", "missing": "0"}}, {"transformationsData": {}, "feature": "Day_Charge", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "29.55", "stddev": "9.53", "min": "1.33", "max": "52.21", "missing": "0"}}, {"transformationsData": {}, "feature": "Eve_Mins", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "201.65", "stddev": "52.31", "min": "42.5", "max": "350.9", "missing": "0"}}, {"transformationsData": {}, "feature": "Eve_Calls", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "100.04", "stddev": "20.28", "min": "45", "max": "170", "missing": "0"}}, {"transformationsData": {}, "feature": "Eve_Charge", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "17.14", "stddev": "4.45", "min": "3.61", "max": "29.83", "missing": "0"}}, {"transformationsData": {}, "feature": "Night_Mins", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "199.24", "stddev": "49.49", "min": "23.2", "max": "352.2", "missing": "0"}}, {"transformationsData": {}, "feature": "Night_Calls", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "100.03", "stddev": "19.39", "min": "33", "max": "155", "missing": "0"}}, {"transformationsData": {}, "feature": "Night_Charge", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "8.97", "stddev": "2.23", "min": "1.04", "max": "15.85", "missing": "0"}}, {"transformationsData": {}, "feature": "Intl_Mins", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "10.01", "stddev": "2.93", "min": "0.0", "max": "18.2", "missing": "0"}}, {"transformationsData": {}, "feature": "total_Mins", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "584.74", "stddev": "93.56", "min": "301.5", "max": "818.2", "missing": "0"}}, {"transformationsData": {}, "feature": "Intl_Calls", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "4.51", "stddev": "2.5", "min": "0", "max": "18", "missing": "0"}}, {"transformationsData": {}, "feature": "Intl_Charge", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "2.7", "stddev": "0.79", "min": "0.0", "max": "4.91", "missing": "0"}}, {"transformationsData": {}, "feature": "Total_Charge", "transformation": "", "type": "real", "selected": "True", "stats": {"count": "341", "mean": "58.36", "stddev": "11.0", "min": "23.25", "max": "86.84", "missing": "0"}}, {"transformationsData": {}, "feature": "CustServ_Calls", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "1.5", "stddev": "1.31", "min": "0", "max": "7", "missing": "0"}}, {"transformationsData": {}, "feature": "Churn", "transformation": "", "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "0.14", "stddev": "0.35", "min": "0", "max": "1", "missing": "0"}}, {"transformationsData": {"feature_label": "cluster_labels"}, "feature": "cluster_labels", "transformation": "String Indexer", "type": "string", "selected": "True", "stats": {"count": "341", "mean": "", "stddev": "", "min": "day_callers", "max": "vmailers", "missing": "0", "distinct": "6"}}, {"feature": "State_transform", "transformation": "", "transformationsData": {}, "type": "real", "selected": "True", "stats": {"count": "341", "mean": "18.93", "stddev": "13.93", "min": "0.0", "max": "50.0", "missing": "0"}}, {"feature": "Phone_transform", "transformation": "", "transformationsData": {}, "type": "real", "selected": "True", "stats": {"count": "341", "mean": "170.0", "stddev": "98.58", "min": "0.0", "max": "340.0", "missing": "0"}}, {"feature": "Intl_Plan_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "0.08", "stddev": "0.27", "min": "0", "max": "1", "missing": "0"}}, {"feature": "VMail_Plan_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "341", "mean": "0.28", "stddev": "0.45", "min": "0", "max": "1", "missing": "0"}}, {"feature": "cluster_labels_transform", "transformation": "", "transformationsData": {}, "type": "real", "selected": "True", "stats": {"count": "341", "mean": "2.26", "stddev": "1.72", "min": "0.0", "max": "5.0", "missing": "0"}}]}))
PipelineNotification.PipelineNotification().completed_notification('5da5c65e3cba417ba39880f6','5df78f4be2f2eff24740bbd7','http://13.68.212.36:3200/pipeline/notify')
PipelineNotification.PipelineNotification().started_notification('5da5c65e3cba417ba39880f7','5df78f4be2f2eff24740bbd7','http://13.68.212.36:3200/pipeline/notify')
auto_ml = tpot_execution.Tpot_execution.run(["5da5c65e3cba417ba39880f6"],{"5da5c65e3cba417ba39880f6": transformations}, "5da5c65e3cba417ba39880f7", spark,json.dumps( {"model_type": "classification", "label": "Churn", "features": ["State", "Account_Length", "Area_Code", "Phone", "Intl_Plan", "VMail_Plan", "VMail_Message", "Day_Mins", "Day_Calls", "Day_Charge", "Eve_Mins", "Eve_Calls", "Eve_Charge", "Night_Mins", "Night_Calls", "Night_Charge", "Intl_Mins", "total_Mins", "Intl_Calls", "Intl_Charge", "Total_Charge", "CustServ_Calls", "cluster_labels"], "percentage": "90", "executionTime": 15, "sampling": "1", "sampling_value": "over", "run_id": "", "model_id": "5df7aa6487de1d58137e89c7", "ProjectName": "Retail Scenarios", "PipelineName": "PredictiveChurn(Demo)", "userid": "5df78f4be2f2eff24740bbd7", "url_ResultView": "http://13.68.212.36:3200", "experiment_id": "480623611921769"}))
PipelineNotification.PipelineNotification().completed_notification('5da5c65e3cba417ba39880f7','5df78f4be2f2eff24740bbd7','http://13.68.212.36:3200/pipeline/notify')

